<!DOCTYPE html>
<html>
  <head>
    <script>
        // TODO: move this to an script.js" file 
        const websocketURL = "ws://localhost:8080/chat"
        let socket;

        document.addEventListener("DOMContentLoaded", async function(){
            setChatFormListener();

            connectWebsocket();
            setWebsocketListeners(socket);
        });

        /* Websockets */
        function connectWebsocket() {
            socket = new WebSocket(websocketURL);
        }

        function setWebsocketListeners(socket) {
            socket.addEventListener("open", (event) => {
                console.log("Websocket connection established")
            }) 

            socket.addEventListener("message", (event) => {
                const reader = new FileReader();
                if (event.data instanceof Blob) {
                    reader.addEventListener("loadend", () => {
                        const decoder = new TextDecoder();
                        const rawData = decoder.decode(reader.result);
                        const data = JSON.parse(rawData);
                        renderMessages(data.messages);
                    })

                    reader.readAsArrayBuffer(event.data);
                }
            })
        }

        function sendWebsocketMessage(content) {
            if (!socket) {
                throw new Error("Websocket connection is not established!")
            }

            const message = {
                nickname: "william",
                content: content
            }

            socket.send(JSON.stringify(message))
        }

        /* Messages */
        function renderMessages(messages) {
            const list = document.getElementById("messages");
            deleteMessagesFromList();
            
            for (const message of messages) {
                const item = document.createElement("li");
                item.textContent = message.content 
                item.classList.add("message")
                list.appendChild(item)
            }
        }

        function deleteMessagesFromList() {
            const list = document.getElementById("messages");
            while(list.firstChild) {
                list.removeChild(list.firstChild);
            }
        }

        async function sendMessage() {
            await fetch("http://localhost:8080/new-message")
        }

        function createMessageHTMLElement(listItem) {
           const div = document.createElement("div") 
           item.classList.add("message")
        }

        function setChatFormListener() {
            const form = document.getElementById("chat-form");
            form.addEventListener("submit", (event) => {
                event.preventDefault();

                const formData = new FormData(form);
                const message = formData.get("message");

                sendWebsocketMessage(message);
            });
        } 
    </script>
    <title>Cool Chat</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <style>
      html,
      body {
        height: 100vh;
      }

      main {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
      }

      .chat {
        display: flex;
        flex-direction: column;
        height: 80%;
        width: 50%;
        background-color: #C8C8C8;
        box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
      }

      .messages-wrapper {
          height: 90%;
          width: 100%;
      }

      .messages-list {
          display: flex;
          flex-direction: column;
          flex-grow: 1;
          gap: 1rem;
          list-style-type: none;
      }

      .message {
          width: 20%;
          padding: 0.5rem;
          border-radius: 2px;
          background-color: orange;
          border: 0px;
      }

      .chat-form {
        display: flex;
        align-items: cente;
        flex-direction: row;
        height: 10%;
      }

      .chat-input {
          width: 80%;
          padding: 0px;
          border: 0;
      }
        
      .chat-send-button {
          flex-grow: 1;
          border: 0;
      }

    </style>
  </head>
  <body>
    <main>
        <div class="chat">
            <div class="messages-wrapper">
                <ul id="messages" class="messages-list">
                </ul>
            </div>
            <form id="chat-form" class="chat-form">
                <input
                    id="chat-input"
                    name="message"
                    class="chat-input"
                    placeholder="Write your message here..."
                />
                <button class="chat-send-button">
                    Send
                </button>
            </form>
        </div>
    </main>
  </body>
</html>
